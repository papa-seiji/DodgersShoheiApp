<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>WBC MATCHES ADMIN</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    select, input {
      width: 100%;
      box-sizing: border-box;
    }
    .msg {
      margin-top: 10px;
      color: green;
    }
  </style>
</head>
<body>

<h1>WBC MATCHES</h1>

<p>year = <span th:text="${year}">2026</span></p>
<p>round = <span th:text="${round}">QF</span></p>
<p>matches size = <span th:text="${#lists.size(matches)}">0</span></p>

<table>
  <thead>
    <tr>
      <th>Round</th>
      <th>No</th>
      <th>Home-T</th>
      <th>H-Score</th>
      <th>A-Score</th>
      <th>Away-T</th>
      <th>Winner</th>
      <th>Action</th>
    </tr>
  </thead>

  <tbody>
    <tr th:each="m : ${matches}">
      <td class="round" th:text="${m.round}">QF</td>
      <td class="match-no" th:text="${m.matchNo}">1</td>

      <!-- Home Team -->
      <td>
        <select class="home-team" th:id="'homeTeam-' + ${m.id}">
          <option value="">---</option>
          <option th:each="t : ${teamList}"
                  th:value="${t}"
                  th:text="${t}"
                  th:selected="${t == m.homeTeam}">
          </option>
        </select>
      </td>

      <!-- Home Score -->
      <td>
        <input type="number" min="0"
               th:id="'homeScore-' + ${m.id}"
               th:value="${m.homeScore}">
      </td>

      <!-- Away Score -->
      <td>
        <input type="number" min="0"
               th:id="'awayScore-' + ${m.id}"
               th:value="${m.awayScore}">
      </td>

      <!-- Away Team -->
      <td>
        <select class="away-team" th:id="'awayTeam-' + ${m.id}">
          <option value="">---</option>
          <option th:each="t : ${teamList}"
                  th:value="${t}"
                  th:text="${t}"
                  th:selected="${t == m.awayTeam}">
          </option>
        </select>
      </td>

      <!-- Winner Team（★ teamList から選択） -->
      <td>
        <select class="winner-team" th:id="'winnerTeam-' + ${m.id}">
          <option value="">-- 未決定 --</option>
          <option th:each="t : ${teamList}"
                  th:value="${t}"
                  th:text="${t}"
                  th:selected="${t == m.winnerTeam}">
          </option>
        </select>
      </td>

      <!-- Action -->
      <td>
        <button type="button"
                th:onclick="'saveMatch(' + ${m.id} + ')'">
          保存
        </button>
      </td>
    </tr>
  </tbody>
</table>

<div id="msg" class="msg"></div>

<!-- =========================
     JavaScript
========================= -->

<script>
function saveMatch(id) {

  const body = {
    id: id,
    homeTeam: document.getElementById("homeTeam-" + id).value,
    awayTeam: document.getElementById("awayTeam-" + id).value,
    homeScore: document.getElementById("homeScore-" + id).value,
    awayScore: document.getElementById("awayScore-" + id).value,
    winnerTeam: document.getElementById("winnerTeam-" + id).value
  };

  fetch("/admin/wbc/api/match/update", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  })
  .then(res => {
    if (!res.ok) throw new Error("update failed");

    // ★ Google風：OK押下で画面更新
    alert("保存しました");
    location.reload();
  })
  .catch(err => {
    alert("保存に失敗しました");
    console.error(err);
  });
}
</script>

<script>
/* =========================
   ★ QF チーム定義（追加）
========================= */
const QF_POOLS_AB = [
  "PUERTO RICO","CUBA","CANADA","PANAMA","COLOMBIA",
  "USA","MEXICO","ITALY","UNITED KINGDOM","BRAZIL"
];

const QF_POOLS_CD = [
  "JAPAN","AUSTRALIA","KOREA","CZECH REPUBLIC","CHINESE TAIPEI",
  "VENEZUELA","DOMINICAN REPUBLIC","NETHERLANDS","ISRAEL","NICARAGUA"
];


/* =================================
   ★ QF Home/Away 制御プルダウン制御
================================== */
function setupQFTeamSelect(row) {
  const round = row.querySelector(".round").innerText;
  const no    = Number(row.querySelector(".match-no").innerText);

  if (round !== "QF") return;

  const homeSel = row.querySelector(".home-team");
  const awaySel = row.querySelector(".away-team");

  const teams = (no === 1 || no === 2) ? QF_POOLS_AB : QF_POOLS_CD;

  [homeSel, awaySel].forEach(sel => {
    const current = sel.value;
    sel.innerHTML = `<option value="">---</option>`;
    teams.forEach(t => {
      sel.innerHTML += `<option value="${t}">${t}</option>`;
    });
    sel.value = current;
  });
}


/* ===========================
   ★ Winner 動的生成連動にする
=========================== */
function updateWinnerSelect(row) {
  const home = row.querySelector(".home-team").value;
  const away = row.querySelector(".away-team").value;
  const win  = row.querySelector(".winner-team");

  const current = win.value;
  win.innerHTML = `<option value="">-- 未決定 --</option>`;

  if (home) win.innerHTML += `<option value="${home}">${home}</option>`;
  if (away) win.innerHTML += `<option value="${away}">${away}</option>`;

  win.value = current;
}
</script>














<script>
/* =========================
   ★ QF Winner 取得
========================= */
function getQFWinners(qfNos) {
  const winners = [];

  qfNos.forEach(no => {
    const row = [...document.querySelectorAll("tbody tr")]
      .find(r =>
        r.querySelector(".round")?.innerText === "QF" &&
        Number(r.querySelector(".match-no")?.innerText) === no
      );

    if (!row) return;

    const w = row.querySelector(".winner-team")?.value;
    if (w) winners.push(w);
  });

  return winners;
}

/* =========================
   ★ SF Home / Away 制御
========================= */
function setupSFTeamSelect(row) {
  const round = row.querySelector(".round").innerText;
  const no    = Number(row.querySelector(".match-no").innerText);

  if (round !== "SF") return;

  const homeSel = row.querySelector(".home-team");
  const awaySel = row.querySelector(".away-team");

  // SF① → QF①② / SF② → QF③④
  const qfTargets = (no === 1) ? [1, 2] : [3, 4];
  const teams = getQFWinners(qfTargets);

  [homeSel, awaySel].forEach(sel => {
    const current = sel.value;
    sel.innerHTML = `<option value="">---</option>`;
    teams.forEach(t => {
      sel.innerHTML += `<option value="${t}">${t}</option>`;
    });
    sel.value = current;
  });
}

document.querySelectorAll(".winner-team").forEach(sel => {
  sel.addEventListener("change", () => {
    document.querySelectorAll("tbody tr").forEach(r => {
      setupSFTeamSelect(r);
      updateWinnerSelect(r);
    });
  });
});
</script>




<script>
/* =========================
   ★ 初期化
========================= */
document.querySelectorAll("tbody tr").forEach(row => {
  setupQFTeamSelect(row);
  setupSFTeamSelect(row);   // ★ 追加
  updateWinnerSelect(row);

  row.querySelector(".home-team").addEventListener("change", () => {
    updateWinnerSelect(row);
  });
  row.querySelector(".away-team").addEventListener("change", () => {
    updateWinnerSelect(row);
  });
});
</script>


</body>
</html>
