<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MLB Postseason 2025</title>
  <link rel="stylesheet" th:href="@{/css/postseason_simple.css}" />
</head>

<body>
  <div class="container">
    <h1>MLB POSTSEASON 2025</h1>

    <!-- AMERICAN LEAGUE -->
    <div class="league al">
      <h2>AMERICAN LEAGUE</h2>
      <div class="bracket">
        <div class="round" id="al-wcs">
          <h3>WILD CARD SERIES</h3>
          <div class="matchups"></div>
        </div>
        <div class="round" id="al-ds">
          <h3>DIVISION SERIES</h3>
          <div class="matchups"></div>
        </div>
        <div class="round" id="al-lcs">
          <h3>LEAGUE CHAMPIONSHIP SERIES</h3>
          <div class="matchups"></div>
        </div>
      </div>
    </div>

    <!-- WORLD SERIES -->
    <div class="world-series">
      <h2>WORLD SERIES</h2>
      <div class="round" id="ws">
        <div class="matchups"></div>
      </div>
    </div>

    <!-- NATIONAL LEAGUE -->
    <div class="league nl">
      <h2>NATIONAL LEAGUE</h2>
      <div class="bracket">
        <div class="round" id="nl-wcs">
          <h3>WILD CARD SERIES</h3>
          <div class="matchups"></div>
        </div>
        <div class="round" id="nl-ds">
          <h3>DIVISION SERIES</h3>
          <div class="matchups"></div>
        </div>
        <div class="round" id="nl-lcs">
          <h3>LEAGUE CHAMPIONSHIP SERIES</h3>
          <div class="matchups"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch("/api/mlb/postseason");
      const data = await res.json();

      const AL_TEAMS = [
        "Yankees","Red Sox","Blue Jays","Rays","Orioles",
        "White Sox","Guardians","Tigers","Royals","Twins",
        "Astros","Rangers","Mariners","Angels","Athletics"
      ];
      const NL_TEAMS = [
        "Dodgers","Padres","Giants","Rockies","Diamondbacks",
        "Cubs","Cardinals","Pirates","Reds","Brewers",
        "Braves","Mets","Nationals","Phillies","Marlins"
      ];

      // üß© „Ç´„Éº„ÉâÁîüÊàêÔºàÊûùÁ∑öÂØæÂøúÔºâ
      function createCard(series, team1, team2, wins1, wins2, team1Id, team2Id) {
        const matchup = document.createElement("div");
        matchup.className = "matchup";

        if (series.includes("World")) {
          if (team1 === "Higher WPCT") team1 = "AL CHAMPION";
          if (team2 === "Lower WPCT") team2 = "NL CHAMPION";
        }

        const winner = wins1 > wins2 ? team1 : wins2 > wins1 ? team2 : null;
        const logo1 = team1Id ? `https://www.mlbstatic.com/team-logos/${team1Id}.svg` : "";
        const logo2 = team2Id ? `https://www.mlbstatic.com/team-logos/${team2Id}.svg` : "";

        matchup.innerHTML = `
          <strong class="series-title">${series}</strong>
          <div class="teams">
            <div class="team">
              <img src="${logo1}" alt="${team1}">
              ${winner === team1 ? '<div class="trophy">üèÜ</div>' : ''}
            </div>
            <div class="team">
              <img src="${logo2}" alt="${team2}">
              ${winner === team2 ? '<div class="trophy">üèÜ</div>' : ''}
            </div>
          </div>
        `;
        return matchup;
      }

      // üßæ Ë©¶Âêà„Éá„Éº„ÇøÂèéÈõÜ
      const games = [];
      for (const date of data.dates || []) {
        for (const game of date.games || []) {
          games.push(game);
        }
      }

      // üóÇ „Ç∑„É™„Éº„Ç∫Âçò‰Ωç„Åß„Éû„ÉÉ„Éî„É≥„Ç∞
      const matchupMap = {};
      for (const game of games) {
        const series = game.seriesDescription || "Unknown Series";
        const home = game.teams?.home?.team?.name || "Home Team";
        const away = game.teams?.away?.team?.name || "Away Team";
        const homeId = game.teams?.home?.team?.id;
        const awayId = game.teams?.away?.team?.id;
        const sortedTeams = [home, away].sort();
        const key = `${series}_${sortedTeams[0]}_vs_${sortedTeams[1]}`;
        const homeWins = game.teams?.home?.leagueRecord?.wins || 0;
        const awayWins = game.teams?.away?.leagueRecord?.wins || 0;

        if (!matchupMap[key]) {
          matchupMap[key] = {
            series,
            teams: {
              [home]: { wins: homeWins, id: homeId },
              [away]: { wins: awayWins, id: awayId }
            }
          };
        } else {
          matchupMap[key].teams[home].wins = Math.max(matchupMap[key].teams[home].wins, homeWins);
          matchupMap[key].teams[away].wins = Math.max(matchupMap[key].teams[away].wins, awayWins);
        }
      }

      // üß© ÊèèÁîª
      const appendToSection = (series, card) => {
        const select = (id) => document.querySelector(`${id} .matchups`);
        if (series.includes("World")) {
          select("#ws").appendChild(card);
        } else if (AL_TEAMS.some(t => series.includes(t) || card.innerHTML.includes(t))) {
          if (series.includes("Wild")) select("#al-wcs").appendChild(card);
          else if (series.includes("Division")) select("#al-ds").appendChild(card);
          else if (series.includes("League")) select("#al-lcs").appendChild(card);
        } else if (NL_TEAMS.some(t => series.includes(t) || card.innerHTML.includes(t))) {
          if (series.includes("Wild")) select("#nl-wcs").appendChild(card);
          else if (series.includes("Division")) select("#nl-ds").appendChild(card);
          else if (series.includes("League")) select("#nl-lcs").appendChild(card);
        }
      };

      Object.values(matchupMap).forEach(({ series, teams }) => {
        const [team1, team2] = Object.keys(teams);
        if (!team1 || !team2) return;
        const wins1 = teams[team1].wins;
        const wins2 = teams[team2].wins;
        const id1 = teams[team1].id;
        const id2 = teams[team2].id;
        const card = createCard(series, team1, team2, wins1, wins2, id1, id2);
        appendToSection(series, card);
      });

      // üß© ÊûùÁ∑ö„ÅÆÁ∏¶Êé•Á∂ö„ÇíËøΩÂä†
      function addConnectors() {
        document.querySelectorAll('.round').forEach(round => {
          const matchups = round.querySelectorAll('.matchup');
          for (let i = 0; i < matchups.length; i += 2) {
            const connector = document.createElement('div');
            connector.classList.add('connector-vertical');
            matchups[i].appendChild(connector);
          }
        });
      }
      addConnectors();

      console.log("‚úÖ MLB POSTSEASONÔºàÊûùÁ∑ö‰ªò„Åç„Éà„Éº„Éä„É°„É≥„ÉàÔºâÂèçÊò†ÂÆå‰∫Ü");
    } catch (e) {
      console.error("„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó:", e);
    }
  });
  </script>
</body>
</html>
