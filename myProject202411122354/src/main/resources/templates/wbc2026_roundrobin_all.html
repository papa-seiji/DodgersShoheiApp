<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!--<meta name="viewport">-->
<title>WBC2026 Round Robin</title>

<style>
body {
  font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  background: #f7f7f7;
}

.wrapper {
  max-width: 1200px;
  margin: 40px auto;
}

/* ===== タブ ===== */
.pool-tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.pool-tabs button {
  padding: 8px 16px;
  border: 1px solid #333;
  background: #fff;
  cursor: pointer;
  font-weight: 700;
}

.pool-tabs button.active {
  background: #000;
  color: #fff;
}

/* ===== POOL表示制御 ===== */
.pool-panel { display: none; }
.pool-panel.active { display: block; }

/* ===== テーブル ===== */
.round-robin-table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  table-layout: fixed;
}

.round-robin-table th,
.round-robin-table td {
  border: 1.5px solid #000;
  text-align: center;
  padding: 6px;
  font-size: 14px;
}

.round-robin-table th {
  background: #eee;
  font-weight: 700;
}

.team-name {
  text-align: left;
  padding-left: 8px;
  font-weight: 700;
  background: #fafafa;
}

.no-game { background: #ddd; }
.win { font-weight: 800; }
.lose { opacity: 0.6; }

.rank-col {
  background: #f2f2f2;
  font-weight: 700;
}

/* ===============================
   戻るボタン
================================ */
.back-area {
  margin: 40px auto 60px;
  text-align: center;
}

.back-button {
    display: inline-block;
    padding: 32px 48px;
    background: #fb0000;
    color: #fff;
    font-weight: bold;
    text-decoration: none;
    border-radius: 6px;
    transition: opacity 0.2s ease;
}

.back-button:hover {
  opacity: 0.8;
}




.team-cell {
  display: flex;
  align-items: center;
  gap: 6px;
}

.team-flag {
  width: 26px;
  border: 1px solid #ccc;
}

.team-name-short {
  font-weight: 700;
}

/* スマホは国旗のみ */
@media (max-width: 430px) {
  .team-name-full,
  .team-name-short {
    display: none;
  }

  .team-cell {
    justify-content: center;
  }
}


/* =========================
   チーム名 表示制御（確定版）
========================= */

/* デフォルト（430px超） */
.team-name-full {
  display: none;        /* フル名は使わない */
}

.team-name-short {
  display: inline;      /* 3文字表示 */
  font-weight: 700;
  margin-left: 6px;
}

/* スマホ（430px以下） */
@media screen and (max-width: 430px) {
  .team-name-short {
    display: none;      /* 国旗のみ */
  }

  .team-flag {
    width: 26px;
    height: auto;
  }
}


</style>
</head>

<body>
<div class="wrapper">

<!-- ===== タブ ===== -->
<div class="pool-tabs">
  <a th:href="@{/wbc/roundrobin(mode=${param.mode}, pool='A')}">
    <button
      th:classappend="${#strings.equals(param.pool?.get(0), 'A') or param.pool == null} ? ' active' : ''">
      POOL A
    </button>
  </a>

  <a th:href="@{/wbc/roundrobin(mode=${param.mode}, pool='B')}">
    <button
      th:classappend="${#strings.equals(param.pool?.get(0), 'B')} ? ' active' : ''">
      POOL B
    </button>
  </a>

  <a th:href="@{/wbc/roundrobin(mode=${param.mode}, pool='C')}">
    <button
      th:classappend="${#strings.equals(param.pool?.get(0), 'C')} ? ' active' : ''">
      POOL C
    </button>
  </a>

  <a th:href="@{/wbc/roundrobin(mode=${param.mode}, pool='D')}">
    <button
      th:classappend="${#strings.equals(param.pool?.get(0), 'D')} ? ' active' : ''">
      POOL D
    </button>
  </a>
</div>

<!-- ================= POOL ABCD ================= -->
<div id="poolC" class="pool-panel active">

  <h2 th:text="' (' + ${teams.size()} + ' teams)'"></h2>

  <table class="round-robin-table">
    <tr>
      <th></th>

      <!-- ===== 列ヘッダ（AWAY） ===== -->
<th th:each="away : ${teams}">
  <div class="team-cell">
<img class="team-flag"
     th:src="${
       'https://dodgersshoheiapp-assets.s3.us-east-1.amazonaws.com/img/2026_WBC/flags/' +
       (away == 'JAPAN' ? 'jp' :
        away == 'KOREA' ? 'kr' :
        away == 'AUSTRALIA' ? 'au' :
        away == 'CHINESE TAIPEI' ? 'tw' :
        away == 'CZECH REPUBLIC' ? 'cz' :
        away == 'CUBA' ? 'cu' :
        away == 'PANAMA' ? 'pa' :
        away == 'PUERTO RICO' ? 'pr' :
        away == 'COLOMBIA' ? 'co' :
        away == 'CANADA' ? 'ca' :
        away == 'MEXICO' ? 'mx' :
        away == 'UNITED KINGDOM' ? 'gb' :
        away == 'USA' ? 'us' :
        away == 'BRAZIL' ? 'br' :
        away == 'ITALY' ? 'it' :
        away == 'NETHERLANDS' ? 'nl' :
        away == 'VENEZUELA' ? 've' :
        away == 'NICARAGUA' ? 'ni' :
        away == 'DOMINICAN REPUBLIC' ? 'do' :
        away == 'ISRAEL' ? 'il' : 'xx')
       + '.jpg'
     }"
     alt="flag">
         <span class="team-name-full" th:text="${away}">TEAM</span>
    <span class="team-name-short"
          th:text="${#strings.substring(away,0,3)}">AAA</span>
  </div>
</th>

      <th class="rank-col">勝</th>
      <th class="rank-col">敗</th>
      <th class="rank-col">得失</th>
      <th class="rank-col">順位</th>
    </tr>

    <!-- ===== 行（HOME） ===== -->
    <tr th:each="home : ${teams}">
<th class="team-name">
  <div class="team-cell">
<img class="team-flag"
     th:src="${
       'https://dodgersshoheiapp-assets.s3.us-east-1.amazonaws.com/img/2026_WBC/flags/' +
       (home == 'JAPAN' ? 'jp' :
        home == 'KOREA' ? 'kr' :
        home == 'AUSTRALIA' ? 'au' :
        home == 'CHINESE TAIPEI' ? 'tw' :
        home == 'CZECH REPUBLIC' ? 'cz' :
        home == 'CUBA' ? 'cu' :
        home == 'PANAMA' ? 'pa' :
        home == 'PUERTO RICO' ? 'pr' :
        home == 'COLOMBIA' ? 'co' :
        home == 'CANADA' ? 'ca' :
        home == 'MEXICO' ? 'mx' :
        home == 'UNITED KINGDOM' ? 'gb' :
        home == 'USA' ? 'us' :
        home == 'BRAZIL' ? 'br' :
        home == 'ITALY' ? 'it' :
        home == 'NETHERLANDS' ? 'nl' :
        home == 'VENEZUELA' ? 've' :
        home == 'NICARAGUA' ? 'ni' :
        home == 'DOMINICAN REPUBLIC' ? 'do' :
        home == 'ISRAEL' ? 'il' : 'xx')
       + '.jpg'
     }"
     alt="flag">
         <span class="team-name-full" th:text="${home}">HOME</span>
    <span class="team-name-short"
          th:text="${#strings.substring(home,0,3)}">AAA</span>
  </div>
</th>

      <td th:each="away : ${teams}"
          th:with="row=${matrix.get(home)},
                   cell=${row != null ? row.get(away) : null}"
          th:classappend="${cell != null and cell.self} ? 'no-game' : ''">
        <span th:utext="${cell != null ? cell.display : '—'}">—</span>
      </td>

      <td class="rank-col" th:text="${stats.get(home)?.win ?: 0}">0</td>
      <td class="rank-col" th:text="${stats.get(home)?.lose ?: 0}">0</td>
      <td class="rank-col" th:text="${stats.get(home)?.runDiff ?: 0}">0</td>
      <td class="rank-col" th:text="${stats.get(home)?.rank ?: '-'}">-</td>
    </tr>
  </table>
</div>

<div class="back-area">
  <a href="#" id="backToStanding" class="back-button">
    ← POOL順位一覧へ戻る
  </a>
</div>



<script>
/* ===== タブ切替 ===== */
const tabs = document.querySelectorAll(".pool-tabs button");
const panels = document.querySelectorAll(".pool-panel");

tabs.forEach(btn => {
  btn.onclick = () => {
    tabs.forEach(b => b.classList.remove("active"));
    panels.forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.target).classList.add("active");
  };
});

/* ===== 勝敗・得失点・順位 自動計算 =====
   ※ POOL C は Thymeleaf 描画のため除外
=========================================== */
document.querySelectorAll(".round-robin-table").forEach(table => {

  // ★★★ ここが唯一の追加ポイント ★★★
  // POOL C（Thymeleaf描画）は JS 集計しない
  if (table.closest("#poolC")) {
    return;
  }

  const rows = Array.from(table.querySelectorAll("tr")).slice(1);

  const teams = rows.map(row => {
    const tds = Array.from(row.querySelectorAll("td"));
    let win = 0;
    let lose = 0;
    let scored = 0;
    let allowed = 0;

    tds.forEach(td => {
      const text = td.textContent;

      if (text.includes("◯")) win++;
      if (text.includes("●")) lose++;

      const match = text.match(/(\d+)\s*-\s*(\d+)/);
      if (match) {
        scored += parseInt(match[1], 10);
        allowed += parseInt(match[2], 10);
      }
    });

    const diff = scored - allowed;
    row.querySelector(".win-count").textContent = win;
    row.querySelector(".lose-count").textContent = lose;
    row.querySelector(".run-diff").textContent =
      diff > 0 ? `+${diff}` : diff;

    return { row, win, lose, diff };
  });

  teams
    .sort((a, b) => b.win - a.win || b.diff - a.diff)
    .forEach((t, i) => {
      t.row.querySelector(".rank").textContent = i + 1;
    });
});
</script>

<script>
/*
=====================================
 RoundRobin 詳細 → 元画面へ戻る制御（修正版）
=====================================
*/
document.addEventListener("DOMContentLoaded", () => {

  const backBtn = document.getElementById("backToStanding");
  if (!backBtn) return;

  backBtn.addEventListener("click", (e) => {
    e.preventDefault();

    const params = new URLSearchParams(window.location.search);
    const mode = params.get("mode");

    let target = "/WorldBaseballClassic";

    if (mode === "japan" || mode === "all") {
      target += "?mode=" + mode;
    }

    // ★ hash は必ずこれだけ
    target += "#pool-title";

    window.location.href = target;
  });

});
</script>

</body>
</html>
